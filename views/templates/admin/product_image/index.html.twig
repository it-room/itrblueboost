{% extends '@PrestaShop/Admin/layout.html.twig' %}

{% set layoutHeaderToolbarBtn = {
    'add': {
        'href': path('admin_product_form', {id: id_product}),
        'desc': 'Back to product'|trans({}, 'Modules.Itrblueboost.Admin'),
        'icon': 'arrow_back'
    }
} %}

{% block content %}
    <style>
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 15px;
        }
        .image-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            transition: box-shadow 0.2s;
        }
        .image-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .image-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .image-card-body {
            padding: 12px;
        }
        .image-card-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .image-card-actions .btn {
            flex: 1;
        }
        .image-card-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .image-card img {
            cursor: zoom-in;
        }
    </style>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-header-title mb-0">
                <i class="material-icons">image</i>
                {{ 'AI Images - '|trans({}, 'Modules.Itrblueboost.Admin') }}{{ product_name }}
            </h3>
            <div class="toolbar-icons">
                <button type="button" class="btn btn-success" id="btn-generate-image"
                        data-prompts-url="{{ path('itrblueboost_admin_product_image_prompts') }}"
                        data-generate-url="{{ path('itrblueboost_admin_product_image_generate', { id_product: id_product }) }}"
                        data-status-url="{{ path('itrblueboost_admin_product_image_job_status', { jobId: 0 }) }}"
                        data-process-url="{{ path('itrblueboost_admin_product_image_process_job', { jobId: 0 }) }}">
                    <i class="material-icons">auto_awesome</i>
                    {{ 'Generate Image (AI)'|trans({}, 'Modules.Itrblueboost.Admin') }}
                </button>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-header-title mb-0">
                <i class="material-icons">hourglass_empty</i>
                {{ 'Pending images'|trans({}, 'Modules.Itrblueboost.Admin') }}
                <span class="badge badge-warning ml-2">{{ pending_images|length }}</span>
            </h3>
        </div>
        <div class="card-body">
            {% if pending_images|length > 0 %}
                <div class="image-grid">
                    {% for image in pending_images %}
                        <div class="image-card" id="image-card-{{ image.id_itrblueboost_product_image }}">
                            <img src="{{ image.url }}" alt="Image {{ image.id_itrblueboost_product_image }}" loading="lazy">
                            <div class="image-card-body">
                                <div class="image-card-info">
                                    #{{ image.id_itrblueboost_product_image }} - {{ image.date_add|date('d/m/Y H:i') }}
                                </div>
                                <div class="image-card-actions">
                                    <button type="button" class="btn btn-sm btn-success btn-accept"
                                            data-url="{{ path('itrblueboost_admin_product_image_accept', { id_product: id_product, imageId: image.id_itrblueboost_product_image }) }}"
                                            data-id="{{ image.id_itrblueboost_product_image }}"
                                            title="{{ 'Accept'|trans({}, 'Admin.Actions') }}">
                                        <i class="material-icons">check</i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger btn-reject"
                                            data-url="{{ path('itrblueboost_admin_product_image_reject', { id_product: id_product, imageId: image.id_itrblueboost_product_image }) }}"
                                            data-id="{{ image.id_itrblueboost_product_image }}"
                                            title="{{ 'Reject'|trans({}, 'Admin.Actions') }}">
                                        <i class="material-icons">close</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="material-icons">photo_library</i>
                    <p>{{ 'No pending images.'|trans({}, 'Modules.Itrblueboost.Admin') }}</p>
                    <p class="text-muted">{{ 'Click "Generate Image (AI)" to create a new image.'|trans({}, 'Modules.Itrblueboost.Admin') }}</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-header-title mb-0">
                <i class="material-icons">check_circle</i>
                {{ 'Accepted images'|trans({}, 'Modules.Itrblueboost.Admin') }}
                <span class="badge badge-success ml-2">{{ accepted_images|length }}</span>
            </h3>
        </div>
        <div class="card-body">
            {% if accepted_images|length > 0 %}
                <div class="image-grid">
                    {% for image in accepted_images %}
                        <div class="image-card" id="image-card-{{ image.id_itrblueboost_product_image }}">
                            <img src="{{ '/img/p/' ~ (image.id_image|slice(0,1)) ~ '/' ~ (image.id_image|length > 1 ? (image.id_image|slice(1,1)) ~ '/' : '') ~ (image.id_image|length > 2 ? (image.id_image|slice(2,1)) ~ '/' : '') ~ (image.id_image|length > 3 ? (image.id_image|slice(3,1)) ~ '/' : '') ~ image.id_image ~ '.jpg' }}"
                                 alt="Image {{ image.id_image }}" loading="lazy"
                                 onerror="this.src='{{ '/img/p/' ~ image.id_image ~ '.jpg' }}'">
                            <div class="image-card-body">
                                <div class="image-card-info">
                                    PS #{{ image.id_image }} - {{ image.date_upd|date('d/m/Y H:i') }}
                                </div>
                                <div class="image-card-actions">
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete"
                                            data-url="{{ path('itrblueboost_admin_product_image_delete', { id_product: id_product, imageId: image.id_itrblueboost_product_image }) }}"
                                            data-id="{{ image.id_itrblueboost_product_image }}"
                                            title="{{ 'Delete'|trans({}, 'Admin.Actions') }}">
                                        <i class="material-icons">delete</i>
                                        {{ 'Delete'|trans({}, 'Admin.Actions') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="material-icons">collections</i>
                    <p>{{ 'No accepted images.'|trans({}, 'Modules.Itrblueboost.Admin') }}</p>
                    <p class="text-muted">{{ 'Accepted images will appear here and in the product gallery.'|trans({}, 'Modules.Itrblueboost.Admin') }}</p>
                </div>
            {% endif %}
        </div>
    </div>

    {# Lightbox pour zoom sur les images #}
    <div class="image-lightbox" id="imageLightbox">
        <span class="image-lightbox-close">&times;</span>
        <img src="" alt="Zoom" id="lightboxImage">
    </div>

    {% include '@Modules/itrblueboost/views/templates/admin/_partials/_reject_modal.html.twig' with {
        rejectTitle: 'Reject Image'|trans({}, 'Modules.Itrblueboost.Admin'),
    } only %}

    {% include '@Modules/itrblueboost/views/templates/admin/_partials/_generate_modal.html.twig' with {
        generateModalId: 'generateImageModal',
        generateTitle: 'Generate an image with AI'|trans({}, 'Modules.Itrblueboost.Admin'),
        promptSelectLabel: 'Generation style:'|trans({}, 'Modules.Itrblueboost.Admin'),
        promptSelectPlaceholder: 'Choose a style'|trans({}, 'Modules.Itrblueboost.Admin'),
        showBaseImageSelector: true,
        existingImages: existing_images,
        showStepProgress: true,
    } only %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function() {
            'use strict';

            // Lightbox zoom functionality
            var lightbox = document.getElementById('imageLightbox');
            var lightboxImg = document.getElementById('lightboxImage');
            var lightboxClose = document.querySelector('.image-lightbox-close');

            document.querySelectorAll('.image-card img').forEach(function(img) {
                img.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    lightboxImg.src = this.src;
                    lightbox.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
            });

            function closeLightbox() {
                lightbox.classList.remove('active');
                document.body.style.overflow = '';
            }

            lightbox.addEventListener('click', closeLightbox);
            lightboxClose.addEventListener('click', closeLightbox);
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && lightbox.classList.contains('active')) {
                    closeLightbox();
                }
            });

            var btnGenerate = document.getElementById('btn-generate-image');
            var btnConfirm = document.getElementById('btn-confirm-generate');
            var promptSelect = document.getElementById('prompt-select');
            var promptDescription = document.getElementById('prompt-description');
            var promptsLoading = document.getElementById('prompts-loading');
            var promptsError = document.getElementById('prompts-error');
            var promptsList = document.getElementById('prompts-list');
            var generateProgress = document.getElementById('generate-progress');
            var generateResult = document.getElementById('generate-result');
            var creditsWarning = document.getElementById('credits-warning');
            var progressBarFill = document.getElementById('progress-bar-fill');
            var progressPercent = document.getElementById('progress-percent');
            var progressLabel = document.getElementById('progress-label');
            var modal = $('#generateImageModal');

            var pollingInterval = null;
            var isGenerating = false;
            var hasInsufficientCredits = false;

            function updateProgressBar(progress, label) {
                progressBarFill.style.width = progress + '%';
                progressPercent.textContent = progress + '%';
                if (label) {
                    progressLabel.textContent = label;
                }
                updateSteps(progress);
            }

            function updateSteps(progress) {
                var steps = [
                    { id: 'step-init', threshold: 0 },
                    { id: 'step-api', threshold: 10 },
                    { id: 'step-generate', threshold: 30 },
                    { id: 'step-save', threshold: 70 },
                    { id: 'step-done', threshold: 100 }
                ];

                steps.forEach(function(step) {
                    var el = document.getElementById(step.id);
                    if (!el) return;

                    el.classList.remove('active', 'done');

                    if (progress >= step.threshold) {
                        var nextStep = steps[steps.indexOf(step) + 1];
                        if (!nextStep || progress < nextStep.threshold) {
                            el.classList.add('active');
                        } else {
                            el.classList.add('done');
                        }
                    }
                });
            }

            function resetProgressBar() {
                updateProgressBar(0, 'Initializing...');
                progressBarFill.classList.add('animated');
            }

            function stopPolling() {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
                isGenerating = false;
            }

            function buildStatusUrl(jobId) {
                var baseUrl = btnGenerate.dataset.statusUrl;
                return baseUrl.replace('/0/', '/' + jobId + '/');
            }

            function buildProcessUrl(jobId) {
                var baseUrl = btnGenerate.dataset.processUrl;
                return baseUrl.replace('/0/', '/' + jobId + '/');
            }

            function fireAndForgetProcess(jobId) {
                var url = buildProcessUrl(jobId);
                console.log('[ITR] Fire-and-forget process URL:', url);
                fetch(url, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                }).catch(function() {});
            }

            function startPolling(jobId) {
                isGenerating = true;
                var pollCount = 0;
                var maxPolls = 60;
                var consecutiveErrors = 0;
                var statusUrl = buildStatusUrl(jobId);
                var polling = false;

                console.log('[ITR] Polling status URL:', statusUrl);

                pollingInterval = setInterval(function() {
                    if (polling) {
                        return;
                    }

                    pollCount++;
                    if (pollCount > maxPolls) {
                        stopPolling();
                        showError('Generation timeout. Please check the pending images section.');
                        return;
                    }

                    polling = true;

                    fetch(statusUrl, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        polling = false;
                        consecutiveErrors = 0;

                        if (!data.success) {
                            stopPolling();
                            showError(data.message || 'Status check failed.');
                            return;
                        }

                        updateProgressBar(data.progress, data.progress_label);

                        if (data.status === 'completed') {
                            stopPolling();
                            onGenerationCompleted(data.data || {});
                        } else if (data.status === 'failed') {
                            stopPolling();
                            showError(data.error_message || 'Generation failed.');
                        }
                    })
                    .catch(function(err) {
                        polling = false;
                        consecutiveErrors++;
                        console.warn('[ITR] Poll retry #' + consecutiveErrors + ':', err.message);
                        if (consecutiveErrors >= 20) {
                            stopPolling();
                            showError('Cannot reach status endpoint. Please refresh the page to check results.');
                        }
                    });
                }, 5000);
            }

            function onGenerationCompleted(data) {
                progressBarFill.classList.remove('animated');
                updateProgressBar(100, 'Generation completed!');

                var totalGenerated = data.total_generated || 0;
                var creditsUsed = data.credits_used || 0;
                var creditsRemaining = data.credits_remaining || 0;

                var msg = totalGenerated === 1
                    ? 'Image generated successfully.'
                    : totalGenerated + ' images generated successfully.';

                setTimeout(function() {
                    generateProgress.classList.add('d-none');
                    generateResult.innerHTML = '<div class="alert alert-success">' +
                        '<i class="material-icons" style="vertical-align: middle;">check_circle</i> ' + msg +
                        '<br><small>Credits used: ' + creditsUsed + ' | Credits remaining: ' + creditsRemaining + '</small>' +
                        '</div>';
                    generateResult.classList.remove('d-none');
                    setTimeout(function() { window.location.reload(); }, 2000);
                }, 800);
            }

            function showError(message) {
                progressBarFill.classList.remove('animated');
                generateProgress.classList.add('d-none');
                generateResult.innerHTML = '<div class="alert alert-danger">' +
                    '<i class="material-icons" style="vertical-align: middle;">error</i> ' + message +
                    '</div>';
                generateResult.classList.remove('d-none');
                btnConfirm.classList.remove('d-none');
                promptsList.classList.remove('d-none');
            }

            // Prevent closing modal during generation
            modal.on('hide.bs.modal', function(e) {
                if (isGenerating) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    return false;
                }
            });

            if (btnGenerate) {
                btnGenerate.addEventListener('click', function() {
                    promptsLoading.classList.remove('d-none');
                    promptsError.classList.add('d-none');
                    promptsList.classList.add('d-none');
                    generateProgress.classList.add('d-none');
                    generateResult.classList.add('d-none');
                    creditsWarning.classList.add('d-none');
                    hasInsufficientCredits = false;
                    btnConfirm.disabled = true;
                    btnConfirm.classList.remove('d-none');
                    promptSelect.innerHTML = '<option value="">-- Choose a style --</option>';

                    modal.modal('show');

                    fetch(this.dataset.promptsUrl, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        promptsLoading.classList.add('d-none');

                        if (!data.success) {
                            promptsError.textContent = data.message || 'Error loading prompts.';
                            promptsError.classList.remove('d-none');
                            return;
                        }

                        var prompts = data.prompts || [];
                        if (prompts.length === 0) {
                            promptsError.textContent = 'No prompts available.';
                            promptsError.classList.remove('d-none');
                            return;
                        }

                        prompts.forEach(function(prompt) {
                            var option = document.createElement('option');
                            option.value = prompt.id;
                            option.textContent = prompt.title;
                            option.dataset.description = prompt.description || '';
                            promptSelect.appendChild(option);
                        });

                        promptsList.classList.remove('d-none');

                        if (typeof data.credits_remaining === 'number' && data.credits_remaining <= 0) {
                            creditsWarning.classList.remove('d-none');
                            hasInsufficientCredits = true;
                            btnConfirm.disabled = true;
                        }
                    })
                    .catch(function() {
                        promptsLoading.classList.add('d-none');
                        promptsError.textContent = 'Connection error.';
                        promptsError.classList.remove('d-none');
                    });
                });
            }

            if (promptSelect) {
                promptSelect.addEventListener('change', function() {
                    var selectedOption = this.options[this.selectedIndex];
                    promptDescription.textContent = selectedOption.dataset.description || '';
                    btnConfirm.disabled = !this.value || hasInsufficientCredits;
                });
            }

            var selectedBaseImageId = '';
            document.querySelectorAll('.base-image-option').forEach(function(option) {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.base-image-option').forEach(function(o) {
                        o.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedBaseImageId = this.dataset.imageId || '';
                });
            });

            if (btnConfirm) {
                btnConfirm.addEventListener('click', function() {
                    var promptId = promptSelect.value;
                    if (!promptId) return;

                    promptsList.classList.add('d-none');
                    btnConfirm.classList.add('d-none');
                    generateProgress.classList.remove('d-none');
                    generateResult.classList.add('d-none');
                    resetProgressBar();

                    var formData = new FormData();
                    formData.append('prompt_id', promptId);

                    if (selectedBaseImageId) {
                        formData.append('base_image_id', selectedBaseImageId);
                    }

                    fetch(btnGenerate.dataset.generateUrl, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body: formData
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.success && data.job_id) {
                            updateProgressBar(5, 'Job created, starting generation...');
                            fireAndForgetProcess(data.job_id);
                            startPolling(data.job_id);
                        } else {
                            showError(data.message || 'Failed to start generation.');
                        }
                    })
                    .catch(function() {
                        showError('Connection error. Please try again.');
                    });
                });
            }

            function handleImageAction(button, formData) {
                var url = button.dataset.url;
                var id = button.dataset.id;
                var card = document.getElementById('image-card-' + id);

                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                var fetchOptions = {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                };

                if (formData) {
                    fetchOptions.body = formData;
                }

                fetch(url, fetchOptions)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        if (card) {
                            card.style.transition = 'opacity 0.3s';
                            card.style.opacity = '0';
                            setTimeout(function() {
                                card.remove();
                                window.location.reload();
                            }, 300);
                        }
                    } else {
                        alert(data.message || 'Error');
                        button.disabled = false;
                        button.innerHTML = button.classList.contains('btn-accept') ? '<i class="material-icons">check</i>' :
                                          button.classList.contains('btn-reject') ? '<i class="material-icons">close</i>' :
                                          '<i class="material-icons">delete</i> Delete';
                    }
                })
                .catch(function() {
                    alert('Connection error.');
                    button.disabled = false;
                });
            }

            document.querySelectorAll('.btn-accept').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    handleImageAction(this);
                });
            });

            // Reject modal logic (Bootstrap)
            var currentRejectButton = null;

            document.querySelectorAll('.btn-reject').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    currentRejectButton = this;
                    document.getElementById('rejectionReason').value = '';
                    $('#rejectModal').modal('show');
                });
            });

            $('#rejectModal').on('hidden.bs.modal', function() {
                var confirmBtn = document.getElementById('confirmReject');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="material-icons">cancel</i> {{ 'Reject'|trans({}, 'Admin.Actions') }}';
                currentRejectButton = null;
            });

            document.getElementById('confirmReject').addEventListener('click', function() {
                if (!currentRejectButton) {
                    return;
                }

                var rejectionReason = document.getElementById('rejectionReason').value;
                var confirmBtn = this;

                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> {{ 'Processing...'|trans({}, 'Admin.Global') }}';

                var formData = new FormData();
                formData.append('rejection_reason', rejectionReason);

                $('#rejectModal').modal('hide');
                handleImageAction(currentRejectButton, formData);
            });

            document.querySelectorAll('.btn-delete').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    if (confirm('Permanently delete this image? The image will also be removed from the product gallery.')) {
                        handleImageAction(this);
                    }
                });
            });

        })();
    </script>
{% endblock %}
