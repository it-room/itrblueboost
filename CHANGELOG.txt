# Changelog

Toutes les modifications notables de ce module sont documentées dans ce fichier.

## [1.8.2] - 2026-02-24

### Fixed
- Wrapping des appels au routeur Symfony dans des blocs try/catch pour éviter les erreurs lorsque les routes ne sont pas encore en cache (ex. lors de l'installation du module)
- Déplacement des variables de vérification de crédits insuffisants (bulkImgHasInsufficientCredits, bulkHasInsufficientCredits) dans la portée IIFE pour assurer la persistance correcte de l'état dans les fichiers JavaScript

## [1.8.1] - 2026-02-20

### Added
- Vérification des crédits insuffisants dans toutes les modales de génération IA : FAQ produit, FAQ catégorie, contenu produit, image produit
- Vérification également appliquée aux modales de génération en masse : FAQ produit en masse, FAQ catégorie en masse, images produits en masse
- Message d'avertissement "Crédits insuffisants. Veuillez recharger vos crédits pour utiliser la génération IA." affiché lors de l'ouverture d'une modale si les crédits sont <= 0
- Bouton "Générer" désactivé lorsque les crédits sont insuffisants dans toutes les modales (individuelles et en masse)

### Changed
- Méthode `getPromptsAction` dans `ProductFaqController`, `CategoryFaqController`, `ProductContentController` et `ProductImageController` : ajout de `credits_remaining` dans la réponse JSON
- Tous les templates Twig (product_faq, category_faq, product_content, product_image) enrichis avec un div `credits-warning` pour l'affichage du message d'avertissement
- Logique JavaScript mise à jour dans tous les templates et fichiers bulk (admin-category-list-bulk.js, admin-product-list-bulk.js, admin-product-list-bulk-images.js) pour vérifier les crédits restants après le chargement des prompts
- Les crédits restants sont lus depuis la configuration (ITRBLUEBOOST_CREDITS_REMAINING) qui est mise à jour après chaque appel API

### Fixed
- Correction de l'affichage de la description du prompt dans la modale de génération de contenu produit : utilisation de `prompt.short_description` au lieu de `prompt.description` pour correspondre aux données retournées par l'API

## [1.8.0] - 2026-02-13

### Added
- Nouvelle fonctionnalité : onglet "Compatibilité" dans le back-office pour sélectionner la version de Bootstrap (Bootstrap 4, Bootstrap 4 Alpha, Bootstrap 5)
- Nouveau contrôleur Symfony moderne `CompatibilityController` pour la gestion de la compatibilité
- Nouveau type de formulaire `CompatibilityFormType` pour les sélections de version Bootstrap
- Nouvelle classe `CompatibilityDataConfiguration` pour la gestion des données de configuration
- Nouveau fournisseur de données `CompatibilityFormDataProvider` pour le chargement/sauvegarde des données
- Nouvel onglet admin "Compatibilité" sous le menu "ITR Blue Boost"
- Nouvelle table de base de données `ps_itrblueboost_compatibility` pour le stockage des configurations Bootstrap par boutique
- Nouvelle fonctionnalité : sélecteur de mode API (Production / Test) dans les paramètres de compatibilité
- Mode Production utilise l'API apitr-sf.itroom.fr (par défaut)
- Mode Test utilise l'API blueboost.itroom.fr
- Les services `ApiService` et `ApiLogger` résolvent maintenant dynamiquement l'URL de base à partir de la configuration `ITRBLUEBOOST_API_MODE`
- Nouvelle fonctionnalité : génération en masse d'images IA depuis la liste produits avec action groupée "Générer les images (IA)"
- Workflow asynchrone pour la génération en masse : création d'un batch GenerationJob, traitement séquentiel des produits avec suivi de progression
- Nouveau fichier JavaScript `views/js/admin-product-list-bulk-images.js` avec modale de sélection de prompt, sondage de barre de progression et affichage des résultats
- Nouvelles routes : `itrblueboost_admin_product_image_bulk_generate`, `itrblueboost_admin_product_image_bulk_process` pour le workflow de génération en masse
- Nouvelles méthodes contrôleur : `bulkGenerateAction`, `bulkProcessJobAction`, `processBulkJobInline`, `buildApiDataFromProduct` dans `ProductImageController`
- Chargement des assets JavaScript de génération d'images en masse dans `itrblueboost.php` lorsque le service image est actif

### Changed
- Version Bootstrap par défaut définie à Bootstrap 5
- Installation du module initialise la version Bootstrap à Bootstrap 5 pour toutes les boutiques
- Script d'upgrade `upgrade/upgrade-1.8.0.php` pour les installations existantes (création de la table et migration des données)
- Méthode `enrichCompletedJobData` adaptée pour supporter les jobs de batch (id_product=0) générés par la génération en masse d'images

### Improved
- Architecture de configuration extensible pour supporter les futures options de compatibilité

### Fixed
- Adaptation des templates de FAQ produit et catégorie au front-office pour utiliser la version de Bootstrap sélectionnée
- Les templates affichent maintenant le balisage basé sur Bootstrap 4 (data-toggle/data-target) ou Bootstrap 5 (data-bs-toggle/data-bs-target) en fonction du paramètre "Compatibilité"
- Les templates product_faq.tpl et category_faq.tpl sont maintenant compatibles avec Bootstrap 4, Bootstrap 4 Alpha et Bootstrap 5

## [1.7.0] - 2026-02-12

### Added
- Nouvelle entité `GenerationJob` (`src/Entity/GenerationJob.php`) pour le suivi des jobs API asynchrones
- Nouvelle commande Symfony `itrblueboost:process-generation-job` pour le traitement en arrière-plan de la génération d'images
- Endpoint de sondage du statut des jobs (`/itrblueboost/images/job/{jobId}/status`) pour le suivi en temps réel de la progression
- Barre de progression animée avec indicateurs d'étapes (Démarrage, Appel API, Génération, Sauvegarde, Terminé) dans la modale de génération d'images
- Fallback pour traitement inline utilisant `fastcgi_finish_request()` lorsque `exec()` n'est pas disponible
- Nouvelle table de base de données `ps_itrblueboost_generation_job` avec association aux boutiques
- Script d'upgrade `upgrade/upgrade-1.7.0.php` pour créer la table et la configuration requises

### Changed
- `ProductImageController::generateAction()` crée maintenant un job en arrière-plan au lieu de bloquer la requête HTTP
- La réponse de génération d'image retourne désormais un `job_id` au lieu d'attendre la réponse API complète
- Refactorisation du contrôleur avec extraction de méthodes helper (`loadProduct`, `buildApiData`, `createGenerationJob`, etc.) pour une meilleure maintenabilité
- Intégration du service `ApiLogger` dans le flux de génération d'images (`ProcessGenerationJobCommand` et `ProductImageController`)
- Suppression du code d'appel API dupliqué (`callApi`, `callApiWithError`, `extractErrorMessage`, `updateStoredCredits`, `logCreditUsage`) remplacé par l'utilisation centralisée d'`ApiLogger`
- La clé API n'est plus stockée dans les données de demande du job de génération (lue depuis Configuration par ApiLogger)

### Fixed
- Correction des erreurs HTTP 504 Gateway Timeout lors de la génération d'images en rendant les appels API asynchrones
- La modale empêche maintenant la fermeture accidentelle pendant une génération active

### Improved
- Intégration de tous les appels API de génération d'images dans les logs centralisés d'ApiLogger (appels de prompts + génération d'images)
- Ajout du paramètre optionnel `$timeout` à `ApiLogger::call()` pour supporter les timeouts prolongés (300s pour les endpoints d'images vs 120s par défaut)
- Nouvelle méthode pratique `ApiLogger::generateImage()` avec timeout 300s et journalisation automatique des crédits
- Injection du service `ApiLogger` via `services.yml` dans `ProcessGenerationJobCommand` et `ProductImageController` pour une meilleure testabilité

## [1.6.1] - 2026-02-09

### Added
- Toggle entre vue grille (cartes) et vue liste (tableau) sur la page "All Product FAQs" avec persistance localStorage
- Vue liste affichant les FAQs dans un tableau avec colonnes : sélection, référence, question, réponse, statut, actif, date, actions
- Cases à cocher (checkboxes) synchronisées entre les vues grille et liste
- Case "Sélectionner tout" dans l'en-tête du tableau de la vue liste
- Barre d'outils flottante pour les actions en masse (apparaît lors de la sélection d'éléments) avec : Accepter tout, Refuser tout, Supprimer tout, Désélectionner
- Trois nouvelles routes API : `bulk-accept`, `bulk-reject`, `bulk-delete` pour les actions en masse
- Trois nouvelles actions de contrôleur : `bulkAcceptAction`, `bulkRejectAction`, `bulkDeleteAction` avec synchronisation API
- Animation de disparition progressive lors de la suppression d'éléments après les actions en masse
- Notifications toast pour les résultats des actions en masse avec rapport d'erreurs détaillé
- Le refus en masse réutilise la modale de motif de refus existante

### Changed
- AllProductFaqsController enrichi avec support des actions en masse (bulk operations)
- Interface de la page "All Product FAQs" améliorée avec les contrôles de vue et la barre d'outils flottante
- Fichiers modifiés : routes.yml, AllProductFaqsController.php, all_product_faqs/index.html.twig, views/js/admin-content-inline.js

## [1.6.0] - 2026-02-07

### Added
- Nouvelle fonctionnalité : Génération de descriptions produits via IA (descriptions et descriptions courtes)
- Trois nouvelles tables de base de données :
  - `ps_itrblueboost_product_content` : stockage des contenus produits générés
  - `ps_itrblueboost_product_content_lang` : traductions multilingues des contenus
  - `ps_itrblueboost_product_content_shop` : gestion multi-boutiques des contenus
- Nouvelle entité : `ProductContent` pour la gestion des contenus produits
- Deux nouveaux contrôleurs :
  - `ProductContentController` : gestion des contenus générés au niveau produit
  - `AllProductContentsController` : vue d'ensemble et gestion en masse des contenus produits
- Nouvelle constante de configuration : `CONFIG_SERVICE_CONTENT`
- Nouveau menu admin : "All Contenus produits" dans la section du module
- Injection de boutons inline dans le formulaire produit (à côté des champs description)
- Support des deux types de contenu : `description` et `description_short`
- Synchronisation API pour les actions : accept, reject, update des contenus générés
- Mise à jour automatique de la description du produit lors de l'acceptation du contenu généré
- Script d'upgrade `upgrade/upgrade-1.6.0.php` pour créer les tables et la configuration

### Changed
- Architecture extensible pour supporter plusieurs types de contenu IA généré

## [1.5.0] - 2026-02-04

### Changed
- Amélioration majeure des performances : suppression des appels API sur chaque chargement de page du back office
- Les crédits restants sont maintenant stockés en base de données (`ps_configuration` avec la clé `ITRBLUEBOOST_CREDITS_REMAINING`) et lus depuis la configuration au lieu d'appels API
- Les crédits en configuration sont automatiquement mis à jour après chaque appel API (génération FAQ, génération image, récupération infos compte, etc.)
- Extraction de la logique du hook `displayBackOfficeHeader` dans une classe dédiée `src/Hooks/DisplayBackOfficeHeader.php` pour respecter le principe de responsabilité unique

### Added
- Nouvelle classe `src/Hooks/DisplayBackOfficeHeader.php` pour gérer l'affichage du header du back office
- Nouvelle méthode `updateStoredCredits()` dans `src/Service/ApiLogger.php` pour persister les crédits après chaque réponse API
- Nouvelle constante `CONFIG_CREDITS_REMAINING` dans le fichier principal du module
- Ajout de la clé de configuration `ITRBLUEBOOST_CREDITS_REMAINING` à l'installation et désinstallation du module
- Script d'upgrade `upgrade/upgrade-1.5.0.php` pour initialiser la nouvelle clé de configuration

### Fixed
- Correction du stockage des crédits lors de la sauvegarde/validation de la clé API dans `src/Form/ConfigurationDataConfiguration.php`

## [1.4.5] - 2026-02-03

### Improved
- Gestion des erreurs API améliorée dans ProductImageController : capture des messages d'erreur détaillés des réponses API en cas d'erreur HTTP (400, 500, etc.)
- Messages d'erreur affichent maintenant la raison réelle de l'erreur API au lieu d'un message générique "HTTP error XXX"
- Ajout de la journalisation du corps complet de la réponse API en cas d'erreur pour faciliter le débogage
- Support de multiples formats d'erreur : message, error, detail, array errors

## [1.4.4] - 2026-02-03

### Added
- Modale de motif de refus sur la page "All Category FAQs" (même fonctionnalité que All Product FAQs)
- Synchronisation API pour les actions accept, reject, toggle et delete dans AllCategoryFaqsController

### Changed
- AllCategoryFaqsController supprime maintenant la FAQ au lieu de simplement mettre à jour le statut lors du refus (comportement cohérent avec AllProductFaqsController)
- AllCategoryFaqsController rejectAction vérifie maintenant si la FAQ est acceptée avant de permettre le toggle

### Fixed
- JavaScript de all_category_faqs réécrit en JavaScript natif avec modale vanilla (compatible PS 1.7, sans dépendance jQuery)
- Comportement cohérent entre les pages all_product_faqs et all_category_faqs
- Fichiers modifiés : all_category_faqs/index.html.twig, AllCategoryFaqsController.php

## [1.4.3] - 2026-02-03

### Fixed
- Réécriture complète de la modale de motif de refus en JavaScript natif (suppression de la dépendance jQuery)
  - Remplacement du plugin Bootstrap modal de jQuery par des fonctions JavaScript natives (showModal/hideModal)
  - Ajout de la gestion appropriée du backdrop avec fonctionnalité de fermeture au clic
  - Ajout du support de la touche Escape pour fermer la modale
  - Ajout de e.preventDefault() et e.stopPropagation() à tous les gestionnaires de boutons pour éviter les conflits d'événements
  - Compatibilité complète PS 1.7 sans dépendre du plugin modal jQuery/Bootstrap
- Fichiers modifiés : all_product_faqs/index.html.twig

## [1.4.2] - 2026-02-03

### Fixed
- Correction du fonctionnement de la modale de motif de refus sur la page "All Product FAQs" (compatibilité jQuery PS 1.7)
  - Changement de `$('#rejectModal')` pour utiliser `window.jQuery || window.$` afin d'améliorer la compatibilité multi-versions
  - Stockage de la référence modale comme variable pour cohérence avec le template product_faq fonctionnel
  - Remplacement du constructeur `new URL()` par une manipulation de chaîne simplifiée pour la compatibilité navigateurs anciens
- Fichiers modifiés : all_product_faqs/index.html.twig

## [1.4.1] - 2026-02-03

### Fixed
- Correction de la compatibilité PrestaShop 1.7.x : résolution du namespace DataColumn
  - PS 8.x utilise `PrestaShop\PrestaShop\Core\Grid\Column\Type\Common\DataColumn`
  - PS 1.7.x utilise `PrestaShop\PrestaShop\Core\Grid\Column\Type\DataColumn`
  - Ajout d'alias de classes dynamiques pour assurer la compatibilité entre les versions
- Fichiers modifiés : ProductFaqGridDefinitionFactory.php, CategoryFaqGridDefinitionFactory.php

## [1.4.0] - 2026-02-03

### Added
- Ajout du filtre par status (pending/accepted/rejected) au lieu de active/inactive dans la page "All Product FAQs"
- Ajout des boutons Accept/Reject pour les FAQ en status "pending"
- Ajout d'une modale pour saisir le motif de refus lors du rejet
- Synchronisation avec l'API pour les actions accept/reject/toggle

### Changed
- Alignement de la page "All Product FAQs" sur la page "All Category FAQs"
- Le motif de refus est envoyé à l'API lors du rejet
- Fichiers modifiés : routes.yml, AllProductFaqsController.php, index.html.twig (all_product_faqs)

## [1.3.9] - 2026-02-03

### Changed
- Correction du positionnement du menu admin "ITR Blue Boost" : déplacement de la section "Modules" vers la section "Configurer"
- Menu en mode dropdown avec sous-menus (Settings, All images générées, All FAQs produits, All FAQs catégories)

### Fixed
- Correction de la structure des tabs du back-office PrestaShop via script d'upgrade
- Script d'upgrade qui crée les tabs manquants et corrige le parent des tabs existants
- Fichiers modifiés : Installer.php, upgrade-1.3.9.php
